version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # MQTT Broker
  # ---------------------------------------------------------------------------
  mqtt-broker:
    image: eclipse-mosquitto:2
    container_name: mosquitto-broker
    volumes:
      - ./broker/mosquitto/mosquitto.conf:/mosquitto/config/mosquitto.conf
    ports:
      - "2147:2147"
    restart: unless-stopped

  # ---------------------------------------------------------------------------
  # Database
  # ---------------------------------------------------------------------------
  db:
    image: postgres:16
    container_name: postgres-db
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      POSTGRES_USER: root
      POSTGRES_PASSWORD: root
      POSTGRES_DB: centraDB
    volumes:
      - db_data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U root -d centraDB" ]
      interval: 5s
      timeout: 5s
      retries: 5

  # ---------------------------------------------------------------------------
  # Grafana
  # ---------------------------------------------------------------------------
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    ports:
      - "3001:3000"
    environment:
      - GF_SECURITY_ALLOW_EMBEDDING=true
      - GF_SECURITY_DISABLE_LOGIN_FORM=true
      - GF_AUTH_ANONYMOUS_ENABLED=true
      - GF_AUTH_ANONYMOUS_ORG_ROLE=Admin
      - PG_HOST=db
      - PG_PORT=5432
      - PG_DB=grafanadb
      - PG_USER=root
      - PG_PASSWORD=root
      - GF_SMTP_ENABLED=true
      - GF_SMTP_HOST=smtp.gmail.com:587
      - GF_SMTP_USER=adittypatil89@gmail.com
      - GF_SMTP_PASSWORD=jcteorxchaunhcrc
      - GF_SMTP_FROM_ADDRESS=adittypatil89@gmail.com
      - GF_SMTP_STARTTLS_POLICY=Mandatory
      - GF_SMTP_SKIP_VERIFY=true
      - GF_SMTP_FROM_NAME=Grafana Alerts
    depends_on:
      db:
        condition: service_healthy
    volumes:
      - grafana_data:/var/lib/grafana
      - ./grafana/provisioning:/etc/grafana/provisioning:ro

  # ---------------------------------------------------------------------------
  # RabbitMQ
  # ---------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3-management
    container_name: netra-rabbitmq
    environment:
      RABBITMQ_DEFAULT_USER: Netra
      RABBITMQ_DEFAULT_PASS: "netra@123"
    ports:
      - "5673:5672" # AMQP (host:container) - published for host access; containers use 5672
      - "15673:15672" # Management UI
    healthcheck:
      test: [ "CMD", "rabbitmq-diagnostics", "-q", "ping" ]
      interval: 5s
      timeout: 15s
      retries: 5

  # ---------------------------------------------------------------------------
  # Netra Backend
  # ---------------------------------------------------------------------------
  netra-backend:
    build:
      context: ./Netra_Backend
    container_name: netra-backend
    depends_on:
      - rabbitmq
      - db
    environment:
      # ---------- OpenC3 config ----------
      OPENC3_SCOPE: DEFAULT
      OPENC3_API_HOSTNAME: "openc3-traefik" # <-- set to the actual OpenC3 API service name from cosmos-project/compose.yaml
      OPENC3_API_PORT: "2900"
      OPENC3_API_PASSWORD: "mos12345"

      # ---------- RabbitMQ: use container DNS + container port ----------
      RABBITMQ_URL: "amqp://Netra:netra%40123@rabbitmq:5672/%2f?heartbeat=0"
      RABBITMQ_EXCHANGE: "telemetry.raw"

      # ---------- Postgres: use service DNS ----------
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_NAME: "centraDB"
      DB_USER: "root"
      DB_PASSWORD: "root"

    networks:
      - default
      - cosmos-project_default
  # ---------------------------------------------------------------------------
  # Netra DB Worker
  # ---------------------------------------------------------------------------
  netra-db-worker:
    build:
      context: ./Netra_Backend
    container_name: netra-db-worker
    depends_on:
      rabbitmq:
        condition: service_healthy
      netra-backend:
        condition: service_started
      db:
        condition: service_healthy
    environment:
      # RabbitMQ Config
      RABBITMQ_URL: "amqp://Netra:netra%40123@rabbitmq:5672/%2f?heartbeat=0"
      RABBITMQ_OUTPUT_EXCHANGE: "telemetry.decoded"

      # Postgres Config
      DB_HOST: "db"
      DB_PORT: "5432"
      DB_NAME: "centraDB"
      DB_USER: "root"
      DB_PASSWORD: "root"
    command: python -m netra_backend.workers.dbworker.dbworker
    networks:
      - default
      - cosmos-project_default

  # ---------------------------------------------------------------------------
  # File Upload Service
  # ---------------------------------------------------------------------------
  file-upload:
    build:
      context: ./FileUpload
    container_name: file-upload-service
    ports:
      - "8080:8080"
    networks:
      - default
      - cosmos-project_default
    environment:
      - C2_API_URL=http://openc3-traefik:2900/openc3-api/api
      - PYTHONUNBUFFERED=1
      - LD_LIBRARY_PATH=/app/lib:$LD_LIBRARY_PATH
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./FileUpload/uploads:/app/uploads
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Schedule Upload Service
  # ---------------------------------------------------------------------------
  schedule-upload:
    build:
      context: ./ScheduleUpload
    container_name: schedule-upload-service
    ports:
      - "8008:8008"
    networks:
      - default
      - cosmos-project_default
    environment:
      - OPEN_C3_URL=http://openc3-traefik:2900/openc3-api/api
      - PYTHONUNBUFFERED=1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    volumes:
      - ./ScheduleUpload/schedules:/app/schedules
      - ./ScheduleUpload/generated_schedules:/app/generated_schedules
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8008/docs" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Transmission History Service
  # ---------------------------------------------------------------------------
  transmission-history:
    build:
      context: ./Transmission_History_Backend
    container_name: transmission-history-service
    ports:
      - "8012:8012"
    networks:
      - default
      - cosmos-project_default
    environment:
      - OPENC3_API_HOSTNAME=openc3-traefik
      - OPENC3_API_PORT=2900
      - OPENC3_API_PASSWORD=mos12345
      - PYTHONUNBUFFERED=1
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8012/packets" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Bridge Backend
  # ---------------------------------------------------------------------------
  bridge-backend:
    build:
      context: ./bridge-backend
    container_name: bridge-backend-service
#    ports:
#      - "8002:8002"
    networks:
      - default
      - cosmos-project_default
    environment:
      - BROKER_A_HOST=mqtt-broker
      - BROKER_A_PORT=2147
      - PYTHONUNBUFFERED=1
      - RUNNING_IN_DOCKER=true
    depends_on:
      - mqtt-broker
    extra_hosts:
      - "host.docker.internal:host-gateway"
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8002/stats" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
  # ---------------------------------------------------------------------------
  # Auth Service
  # ---------------------------------------------------------------------------
  auth-service:
    build:
      context: ./Auth
    container_name: c2-auth-service
    ports:
      - "8001:8001"
    environment:
      - DATABASE_URL=postgresql+asyncpg://root:root@db:5432/centraDB
      - PYTHONUNBUFFERED=1
    depends_on:
      db:
        condition: service_healthy
    networks:
      - default
      - cosmos-project_default
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ---------------------------------------------------------------------------
  # Leafspace Backend
  # ---------------------------------------------------------------------------
  leafspace-backend:
    build:
      context: ./Leafspace
    container_name: leafspace-backend-service
    ports:
      - "8020:8020"
    networks:
      - default
      - cosmos-project_default
    env_file:
      - ./Leafspace/.env
    restart: unless-stopped
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8020/docs" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ---------------------------------------------------------------------------
  # Alert Services
  # ---------------------------------------------------------------------------
  alert-builder:
    build:
      context: ./Netra_Backend/netra_backend/services/Alert_services/alert_builder
      dockerfile: dockerfile
    container_name: netra-alert-builder
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: Netra
      RABBITMQ_PASS: netra@123
    volumes:
      - ./Netra_Backend/netra_backend/services/Alert_services/config:/app/config
    networks:
      - default
      - cosmos-project_default

  alert-worker:
    build:
      context: ./Netra_Backend/netra_backend/services/Alert_services/alert_worker
      dockerfile: dockerfile
    container_name: netra-alert-worker
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: Netra
      RABBITMQ_PASS: netra@123
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: centraDB
      DB_USER: root
      DB_PASSWORD: root
    networks:
      - default
      - cosmos-project_default

  notifier:
    build:
      context: ./Netra_Backend/netra_backend/services/Alert_services/notifier
      dockerfile: dockerfile
    container_name: netra-notifier
    restart: unless-stopped
    depends_on:
      rabbitmq:
        condition: service_healthy
      db:
        condition: service_healthy
    environment:
      RABBITMQ_HOST: rabbitmq
      RABBITMQ_PORT: 5672
      RABBITMQ_USER: Netra
      RABBITMQ_PASS: netra@123
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: centraDB
      DB_USER: root
      DB_PASSWORD: root
      SMTP_HOST: sandbox.smtp.mailtrap.io
      SMTP_PORT: 2525
      SMTP_USER: d0fa56994d1314
      SMTP_PASS: c0777fe5087ddf
      EMAIL_FROM: alerts@netra.local
      EMAIL_TO: operator@netra.local
    networks:
      - default
      - cosmos-project_default
  alert-api:
    build:
      context: ./Netra_Backend/netra_backend/services/Alert_services/alert_api
    container_name: netra-alert-api
    ports:
      - "8003:8000"
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    environment:
      - DATABASE_URL=postgresql+asyncpg://root:root@db:5432/centraDB
      - PYTHONUNBUFFERED=1
    networks:
      - default
      - cosmos-project_default

    # ---------------------------------------------------------------------------
    # Auth Service
    # ---------------------------------------------------------------------------
    # auth-service:
    #   build:
    #     context: ./Auth
    #   container_name: c2-auth-service
    #   ports:
    #     - "8001:8001"
    #   environment:
    #     - DATABASE_URL=postgresql+asyncpg://root:root@db:5432/centraDB
    #     - PYTHONUNBUFFERED=1
    #   depends_on:
    #     db:
    #       condition: service_healthy
    #   networks:
    #     - default
    #     - cosmos-project_default
    #   restart: unless-stopped
    #   healthcheck:
    #     test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
    #     interval: 30s
    #     timeout: 10s
    #     retries: 3
    #   logging:
    #     driver: "json-file"
    #     options:
    #       max-size: "10m"
    #       max-file: "3"

volumes:
  db_data:
  grafana_data:


networks:
  cosmos-project_default:
    external: true
